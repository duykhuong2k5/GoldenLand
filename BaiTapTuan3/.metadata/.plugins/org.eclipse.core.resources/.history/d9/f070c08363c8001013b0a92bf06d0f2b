package com.example.pandora.service;

import com.example.pandora.model.Product;
import com.example.pandora.model.ProductDetail;
import com.example.pandora.model.Review;
import com.example.pandora.repository.ProductDetailRepository;
import com.example.pandora.repository.ProductRepository;
import com.example.pandora.repository.ReviewRepository;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class ProductService {

    private final ProductRepository productRepo;
    private final ProductDetailRepository detailRepo;
    private final ReviewRepository reviewRepo;

    public ProductService(ProductRepository productRepo, ProductDetailRepository detailRepo, ReviewRepository reviewRepo) {
        this.productRepo = productRepo;
        this.detailRepo = detailRepo;
        this.reviewRepo = reviewRepo;
    }

    // ðŸ”¹ Láº¥y táº¥t cáº£ sáº£n pháº©m
    public List<Product> getAllProducts() {
        return productRepo.findAll();
    }

    // ðŸ”¹ Láº¥y sáº£n pháº©m theo ID
    public Product getProductById(Long id) {
        return productRepo.findById(id).orElse(null);
    }

    // ðŸ”¹ ThÃªm sáº£n pháº©m má»›i
    public Product addProduct(Product product) {
        return productRepo.save(product);
    }

    // ðŸ”¹ Cáº­p nháº­t sáº£n pháº©m
    public Product updateProduct(Long id, Product product) {
        Product existing = productRepo.findById(id).orElseThrow(
                () -> new RuntimeException("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m ID: " + id)
        );
        existing.setName(product.getName());
        existing.setPriceNew(product.getPriceNew());
        existing.setPriceOld(product.getPriceOld());
        existing.setDiscountPercent(product.getDiscountPercent());
        existing.setImageUrl(product.getImageUrl());
        existing.setCategory(product.getCategory());
        return productRepo.save(existing);
    }

    // ðŸ”¹ XÃ³a sáº£n pháº©m
    public void deleteProduct(Long id) {
        if (!productRepo.existsById(id)) {
            throw new RuntimeException("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m ID: " + id);
        }
        productRepo.deleteById(id);
    }
    public List<Product> getRelatedProducts(String category, Long excludeId) {
        return productRepository.findByCategoryIgnoreCase(category)
                .stream()
                .filter(p -> !p.getId().equals(excludeId))
                .limit(10)
                .toList();
    }


    // ðŸ”¹ Láº¥y chi tiáº¿t sáº£n pháº©m
    public ProductDetail getProductDetail(Long productId) {
        return detailRepo.findByProductId(productId);
    }

    // ðŸ”¹ LÆ°u / cáº­p nháº­t chi tiáº¿t sáº£n pháº©m
    public ProductDetail saveProductDetail(Long productId, ProductDetail detail) {
        Product product = productRepo.findById(productId).orElseThrow(
                () -> new RuntimeException("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m ID: " + productId)
        );
        detail.setProduct(product);
        return detailRepo.save(detail);
    }

    // ðŸ”¹ Láº¥y danh sÃ¡ch Ä‘Ã¡nh giÃ¡ cá»§a sáº£n pháº©m
    public List<Review> getReviewsByProductId(Long productId) {
        return reviewRepo.findByProductId(productId);
    }

    // ðŸ”¹ ThÃªm Ä‘Ã¡nh giÃ¡ má»›i
    public Review addReview(Long productId, Review review) {
        Optional<Product> productOpt = productRepo.findById(productId);
        if (productOpt.isPresent()) {
            review.setProduct(productOpt.get());
            return reviewRepo.save(review);
        } else {
            throw new RuntimeException("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m ID: " + productId);
        }
    }
}

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:fragment="pageTitle">Danh sÃ¡ch tÃ²a nhÃ  | GodendLand</title>
</head>

<body>
<main layout:fragment="content" class="page-wrapper">

    <!-- ğŸ™ï¸ INTRO -->
    <section class="intro text-center text-white"
             style="background-image: url('https://bizweb.dktcdn.net/100/328/362/themes/894751/assets/bg_breadcrumb.png?1664350964800');
                    background-size: cover; background-position: center; padding: 60px 0;">
        <h1 class="fw-bold display-5">Danh sÃ¡ch tÃ²a nhÃ </h1>
        <ul class="list-inline mt-3 mb-0">
            <li class="list-inline-item">
                <a th:href="@{/trang-chu}" class="text-white text-decoration-none">Trang chá»§</a>
                <span class="mx-1">/</span>
            </li>
            <li class="list-inline-item"><span class="text-light">Táº¥t cáº£ tÃ²a nhÃ </span></li>
        </ul>
    </section>

    <!-- ğŸ” FORM TÃŒM KIáº¾M -->
    <section class="search py-5 bg-light border-bottom">
        <div class="container">
            <form th:action="@{/san-pham}" method="get" th:object="${search}" class="row g-3">
                <div class="col-md-3">
                    <label class="fw-bold mb-1">TÃªn tÃ²a nhÃ </label>
                    <input type="text" th:field="*{name}" class="form-control" placeholder="VÃ­ dá»¥: Sky Tower">
                </div>
                <div class="col-md-3">
                    <label class="fw-bold mb-1">ÄÆ°á»ng</label>
                    <input type="text" th:field="*{street}" class="form-control" placeholder="ÄÆ°á»ng...">
                </div>
                <div class="col-md-3">
                    <label class="fw-bold mb-1">PhÆ°á»ng</label>
                    <input type="text" th:field="*{ward}" class="form-control" placeholder="PhÆ°á»ng...">
                </div>
                <div class="col-md-3">
                    <label class="fw-bold mb-1">Quáº­n</label>
                    <select th:field="*{district}" class="form-select">
                        <option value="">-- Chá»n quáº­n --</option>
                        <option th:each="d : ${districts}" th:value="${d.key}" th:text="${d.value}"></option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="fw-bold mb-1">HÆ°á»›ng</label>
                    <input type="text" th:field="*{direction}" class="form-control" placeholder="VÃ­ dá»¥: ÄÃ´ng Nam">
                </div>

                <div class="col-md-3">
                    <label class="fw-bold mb-1">Sá»‘ táº§ng háº§m</label>
                    <input type="number" th:field="*{numberOfBasement}" class="form-control" min="0">
                </div>

                <div class="col-md-3">
                    <label class="fw-bold mb-1">Diá»‡n tÃ­ch sÃ n (mÂ²)</label>
                    <input type="number" th:field="*{floorArea}" class="form-control" placeholder="VÃ­ dá»¥: 200">
                </div>

                <div class="col-md-3">
                    <label class="fw-bold mb-1">GiÃ¡ thuÃª (tá»« - Ä‘áº¿n)</label>
                    <div class="input-group">
                        <input type="number" th:field="*{rentPriceFrom}" class="form-control" placeholder="Tá»«">
                        <input type="number" th:field="*{rentPriceTo}" class="form-control" placeholder="Äáº¿n">
                    </div>
                </div>

                <div class="col-md-12">
                    <label class="fw-bold mb-1">Loáº¡i tÃ²a nhÃ </label>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="form-check form-check-inline" th:each="type : ${typeCodes}">
						    <input class="form-check-input" type="checkbox"
							       name="typeCode"
							       th:value="${type.key}" 
							       th:checked="${selectedType != null and selectedType == type.key}"
							       id="type__${type.key}">
						    <label class="form-check-label" th:for="'type__' + ${type.key}" th:text="${type.value}"></label>
						</div>
                    </div>
                </div>

                <div class="col-md-12 text-end mt-3">
                    <button type="submit" class="btn btn-success px-4">
                        <i class="fa-solid fa-magnifying-glass me-2"></i>TÃ¬m kiáº¿m
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- ğŸ“‹ DANH SÃCH TÃ’A NHÃ€ -->
    <section class="product py-5">
        <div class="container">
            <div class="row g-4" th:if="${!#lists.isEmpty(projects)}">
                <div class="col-md-4" th:each="b : ${projects}">
                    <div class="card border-0 shadow-sm h-100">
                    	<!-- ğŸ–¼ï¸ HIá»‚N THá»Š áº¢NH -->
						<div class="card-img-wrap">
						  <img th:if="${b.imageUrl != null}"
						       th:src="${b.imageUrl}"
						       alt="áº¢nh tÃ²a nhÃ "
						       class="card-img-fit">
						</div>						
                        <div class="card-body">
                            <h5 class="card-title fw-bold" th:text="${b.name}">Sky Tower</h5>
                            <p class="text-muted mb-2">
							    <i class="fa-solid fa-location-dot text-success me-1"></i>
							    <a th:href="@{https://www.google.com/maps/search/?api=1&query={q}(q=${b.address})}"
							       class="text-decoration-none"
							       target="_blank" rel="noopener"
							       th:text="${b.address}">123 Nguyá»…n Huá»‡</a>
							</p>

							<!-- NÃºt má»Ÿ Google Maps -->
							<a th:href="@{https://www.google.com/maps/search/?api=1&query={q}(q=${b.address})}"
							   class="btn btn-outline-success btn-sm mb-3"
							   target="_blank" rel="noopener">
							   <i class="fa-solid fa-map-location-dot me-1"></i> Xem trÃªn Google Maps
							</a>

                            <ul class="list-unstyled small mb-3">
                                <li>ğŸ“ Diá»‡n tÃ­ch sÃ n: <span th:text="${b.floorArea} + ' mÂ²'">200 mÂ²</span></li>
                                <li>ğŸ“ Quáº£n lÃ½: <span th:text="${b.managerName}">Nguyá»…n VÄƒn A</span> (<span th:text="${b.managerPhone}">0909123456</span>)</li>
                                <li>ğŸ’° GiÃ¡ thuÃª: <span th:text="${b.rentPrice}">25</span> triá»‡u</li>                           
                            </ul>
                            <div class="d-grid gap-2 mt-3">
							    <a th:href="@{'/chi-tiet-toa-nha/' + ${b.id}}"
							       class="btn btn-outline-success fw-bold">
							        ğŸ‘ï¸ Xem chi tiáº¿t
							    </a>
							    <button type="button"
							            class="btn btn-success fw-bold"
							            th:attr="data-id=${b.id}, data-name=${b.name}, data-price=${b.rentPrice}"
							            onclick="payDeposit(this)">
							        ğŸ’° Äáº·t cá»c ngay
							    </button>
							    <button type="button"
							          class="btn btn-outline-secondary"
							          th:attr="data-id=${b.id}, data-name=${b.name}"
							          onclick="addToCompare(this)">
							    ğŸ” ThÃªm so sÃ¡nh
							  </button>
							</div>                 
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ•³ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u -->
            <div th:if="${#lists.isEmpty(projects)}" class="text-center mt-5 text-muted">
                <i class="fa-solid fa-box-open fa-2x mb-3"></i>
                <p>Hiá»‡n chÆ°a cÃ³ tÃ²a nhÃ  nÃ o Ä‘Æ°á»£c Ä‘Äƒng.</p>
            </div>
            <!-- ğŸ“„ PHÃ‚N TRANG -->
		    <nav th:if="${buildingPage != null and buildingPage.totalPages > 1}" aria-label="Pagination" class="mt-4">
			  <ul class="pagination justify-content-center">
			    <li class="page-item" th:classappend="${buildingPage.first} ? 'disabled'">
			      <a class="page-link"
			         th:href="@{/san-pham(
			             page=${buildingPage.number - 1},
			             size=${buildingPage.size},
			             name=${search.name},
			             street=${search.street},
			             ward=${search.ward},
			             district=${search.district},
			             direction=${search.direction},
			             numberOfBasement=${search.numberOfBasement},
			             floorArea=${search.floorArea},
			             rentPriceFrom=${search.rentPriceFrom},
			             rentPriceTo=${search.rentPriceTo},
			             typeCode=${search.typeCode}
			         )}">&laquo;</a>
			    </li>
			
			    <li class="page-item"
			        th:each="p : ${#numbers.sequence(0, buildingPage.totalPages - 1)}"
			        th:classappend="${p == buildingPage.number} ? 'active'">
			      <a class="page-link"
			         th:text="${p + 1}"
			         th:href="@{/san-pham(
			             page=${p},
			             size=${buildingPage.size},
			             name=${search.name},
			             street=${search.street},
			             ward=${search.ward},
			             district=${search.district},
			             direction=${search.direction},
			             numberOfBasement=${search.numberOfBasement},
			             floorArea=${search.floorArea},
			             rentPriceFrom=${search.rentPriceFrom},
			             rentPriceTo=${search.rentPriceTo},
			             typeCode=${search.typeCode}
			         )}">1</a>
			    </li>
			
			    <li class="page-item" th:classappend="${buildingPage.last} ? 'disabled'">
			      <a class="page-link"
			         th:href="@{/san-pham(
			             page=${buildingPage.number + 1},
			             size=${buildingPage.size},
			             name=${search.name},
			             street=${search.street},
			             ward=${search.ward},
			             district=${search.district},
			             direction=${search.direction},
			             numberOfBasement=${search.numberOfBasement},
			             floorArea=${search.floorArea},
			             rentPriceFrom=${search.rentPriceFrom},
			             rentPriceTo=${search.rentPriceTo},
			             typeCode=${search.typeCode}
			         )}">&raquo;</a>
			    </li>
			  </ul>
			</nav>

        </div>
    </section>
    

</main>
<!-- âœ… SCRIPT THANH TOÃN VNPAY -->
<!-- âœ… Äáº·t script vÃ o fragment nÃ y -->
<th:block layout:fragment="scripts">
<script th:inline="javascript">
async function payDeposit(btn) {
  const buildingId   = btn.getAttribute("data-id");
  const buildingName = btn.getAttribute("data-name");
  const rentPrice    = parseFloat(btn.getAttribute("data-price")) || 0;

  // âœ… Láº¥y customerId tá»« backend (Ä‘Ã£ add á»Ÿ controller)
  const customerId = /*[[${currentCustomerId}]]*/ null;

  if (!customerId) {
    alert("âš ï¸ Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ Ä‘áº·t cá»c!");
    return;
  }

  // ğŸ’° Tiá»n cá»c = 10% giÃ¡ thuÃª (triá»‡u â†’ VND)
  const depositAmount = Math.floor(rentPrice * 0.1 * 1_000_000);

  const payload = {
    amount: depositAmount,
    buildingId: Number(buildingId),
    customerId: Number(customerId),
    code: "DATCOC", // backend lá»c Ä‘Ãºng giao dá»‹ch
    note: `Äáº·t cá»c tÃ²a nhÃ  ${buildingName}`
  };

  console.log("ğŸ”¹ Gá»­i payload:", payload);

  try {
    // âœ… Gá»i Ä‘Ãºng endpoint backend (Ä‘Ã£ cÃ³ trong TransactionAPI)
    const res = await fetch('/api/transaction/vnpay', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      alert("âŒ Lá»—i mÃ¡y chá»§ (HTTP " + res.status + ")");
      return;
    }

    const result = await res.json();
    console.log("ğŸ”¹ Pháº£n há»“i tá»« server:", result);

    if (result.message === 'success' && result.data) {
      alert("âœ… Táº¡o Ä‘Æ¡n thanh toÃ¡n thÃ nh cÃ´ng, chuyá»ƒn sang VNPay...");
      window.location.href = result.data; // Redirect sang VNPay
    } else {
      alert("âŒ KhÃ´ng táº¡o Ä‘Æ°á»£c link VNPay: " + result.message);
    }
  } catch (err) {
    console.error("âš ï¸ Fetch error:", err);
    alert("âš ï¸ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§ thanh toÃ¡n.");
  }
}
</script>

<script>
// ========== So sÃ¡nh: localStorage key ==========
const CMP_KEY = 'compare_ids';
const CMP_NAME_KEY = 'compare_names';

// Load thanh so sÃ¡nh khi vÃ o trang
document.addEventListener('DOMContentLoaded', renderCompareBar);

function addToCompare(btn){
	  const id = btn.getAttribute('data-id');
	  const name = btn.getAttribute('data-name');

	  let ids = JSON.parse(localStorage.getItem(CMP_KEY) || '[]');
	  let names = JSON.parse(localStorage.getItem(CMP_NAME_KEY) || '[]');

	  // chá»‘ng trÃ¹ng
	  if (ids.includes(id)) {
	    alert('TÃ²a nÃ y Ä‘Ã£ cÃ³ trong danh sÃ¡ch so sÃ¡nh.');
	    return;
	  }

	  // giá»›i háº¡n tá»‘i Ä‘a 4
	  if (ids.length >= 4) {
	    alert('Báº¡n chá»‰ cÃ³ thá»ƒ so sÃ¡nh tá»‘i Ä‘a 4 tÃ²a.');
	    return;
	  }

	  ids.push(id);
	  names.push(name);

	  localStorage.setItem(CMP_KEY, JSON.stringify(ids));
	  localStorage.setItem(CMP_NAME_KEY, JSON.stringify(names));
	  renderCompareBar();
}


function clearCompare(){
  localStorage.removeItem(CMP_KEY);
  localStorage.removeItem(CMP_NAME_KEY);
  renderCompareBar();
}

function renderCompareBar(){
	  const bar = document.getElementById('compareBar');
	  const list = document.getElementById('compareList');
	  const open = document.getElementById('openCompare');

	  // Ä‘á»c localStorage
	  let ids = JSON.parse(localStorage.getItem(CMP_KEY) || '[]');
	  let names = JSON.parse(localStorage.getItem(CMP_NAME_KEY) || '[]');

	  // Ä‘á»“ng bá»™ Ä‘á»™ dÃ i (phÃ²ng lá»—i cÅ©)
	  if (names.length !== ids.length) {
	    names = names.slice(0, ids.length);
	    localStorage.setItem(CMP_NAME_KEY, JSON.stringify(names));
	  }

	  if (ids.length === 0){
	    bar.classList.add('d-none');
	    list.innerHTML = '';
	    open.href = '/so-sanh';
	    return;
	  }

	  // giá»›i háº¡n hiá»‡n tá»‘i Ä‘a 4 (náº¿u cÃ³ lá»¡ quÃ¡)
	  if (ids.length > 4) {
	    ids = ids.slice(0, 4);
	    names = names.slice(0, 4);
	    localStorage.setItem(CMP_KEY, JSON.stringify(ids));
	    localStorage.setItem(CMP_NAME_KEY, JSON.stringify(names));
	  }

	  bar.classList.remove('d-none');
	  list.innerHTML = names.map((n,i)=> `<span class="badge text-bg-light me-1">${i+1}. ${n}</span>`).join('');

	  // build query ?ids=1&ids=2...
	  const qs = ids.map(id => `ids=${encodeURIComponent(id)}`).join('&');
	  open.href = `/so-sanh?${qs}`;
}
</script>

<style>
.compare-bar{
  position: fixed; left: 50%; transform: translateX(-50%);
  bottom: 20px; z-index: 1100; width: min(960px, 96%);
  background: rgba(33,37,41,.95); color: #fff; border-radius: 10px;
  padding: 10px 14px; display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 8px 22px rgba(0,0,0,.35);
}
</style>


<!-- âœ… NÃšT ZALO Ná»”I -->
<a href="https://zalo.me/0896980501"
   target="_blank"
   id="zaloButton"
   title="LiÃªn há»‡ qua Zalo">
  <img th:src="@{/images/zalo-icon.png}" alt="Zalo">
</a>

<style>
#zaloButton {
  position: fixed;
  bottom: 80px;
  right: 25px;
  z-index: 1000;
  background: white;
  border: 2px solid #198754; /* Xanh lÃ¡ SkyLand */
  border-radius: 50%;
  width: 55px;
  height: 55px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
  transition: transform 0.2s;
}
#zaloButton:hover {
  transform: scale(1.1);
}
#zaloButton img {
  width: 38px;
  height: 38px;
}
/* ====== Card vá»›i hiá»‡u á»©ng cao cáº¥p vÃ  object-fit: contain ====== */
.card {
  border: none;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  transition: transform .35s ease, box-shadow .35s ease;
  background: #fff;
}

.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 16px 32px rgba(0,0,0,.16);
}

/* Khung áº£nh: áº©n pháº§n áº£nh thá»«a khi zoom */
.card-img-wrap {
  width: 100%;
  height: 240px;
  background: #f8f9fa;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  position: relative;
}

/* áº¢nh hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§ (contain) vÃ  phÃ³ng to mÆ°á»£t */
.card-img-fit {
  width: 100%;
  height: 100%;
  object-fit: contain;          /* âœ… hiá»ƒn thá»‹ toÃ n bá»™ áº£nh */
  object-position: center;
  transition: transform .7s cubic-bezier(.25,.8,.25,1),
              filter .5s ease;
  will-change: transform, filter;
  filter: brightness(.95);
}

/* Hover: phÃ³ng to vá»«a pháº£i Ä‘á»ƒ váº«n giá»¯ áº£nh Ä‘áº§y Ä‘á»§ */
.card:hover .card-img-fit {
  transform: scale(1.15);       /* phÃ³ng to ~15% */
  filter: brightness(1.05) saturate(1.08);
}

/* Hiá»‡u á»©ng viá»n sÃ¡ng khi hover */
.card:hover::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 12px;
  box-shadow: 0 0 22px rgba(25, 135, 84, .25);
  pointer-events: none;
}

/* Giáº£m chuyá»ƒn Ä‘á»™ng náº¿u ngÆ°á»i dÃ¹ng báº­t tÃ¹y chá»n */
@media (prefers-reduced-motion: reduce) {
  .card,
  .card-img-fit { transition: none !important; }
}


</style>
<!-- ğŸ” Floating bar so sÃ¡nh -->
<div id="compareBar" class="compare-bar d-none">
  <div>
    <strong>So sÃ¡nh:</strong>
    <span id="compareList"></span>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-light" onclick="clearCompare()">XoÃ¡</button>
    <a id="openCompare" href="/so-sanh" class="btn btn-sm btn-warning">Má»Ÿ trang so sÃ¡nh</a>
  </div>
</div>

</th:block>
</body>
</html>

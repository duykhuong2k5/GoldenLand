<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
  <title layout:fragment="pageTitle">Bài đăng của tôi | GodenLand</title>
  <style>
    .status-badge{padding:.25rem .5rem;border-radius:.35rem;font-weight:600;font-size:.85rem}
    .status-pending{background:#fff3cd;color:#b58100}
    .status-approved{background:#d1e7dd;color:#0f5132}
    .status-rejected{background:#f8d7da;color:#842029}
    .kpi-card{border:1px solid #eee;border-radius:12px;padding:14px 16px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .kpi-label{font-size:.9rem;color:#6c757d}
    .kpi-value{font-size:1.35rem;font-weight:800}
    .table thead th{white-space:nowrap}
    .thumb{width:64px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #e9ecef}
    .rating{font-weight:700}
    .rating .star{margin-left:4px}
  </style>
</head>
<body>
<main layout:fragment="content" class="container py-5">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Bài đăng của tôi</h2>
    <a th:href="@{/web/building-create}" class="btn btn-success">
      <i class="fa-solid fa-plus me-1"></i> Đăng tin mới
    </a>
  </div>

  <!-- KPI header -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Tổng bài đăng</div>
        <div class="kpi-value" th:text="${posts != null ? posts.size() : 0}">0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Tổng lượt xem</div>
        <div class="kpi-value" th:text="${totalViews}">0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Đánh giá TB</div>
        <div class="kpi-value">
          <span th:text="${#numbers.formatDecimal(avgRatingOverall,1,1)}">0.0</span>
          <i class="fa-solid fa-star star"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Tổng doanh thu</div>
        <div class="kpi-value" th:text="${#numbers.formatInteger(totalRevenue,3,'POINT')}">0</div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Ảnh</th>
        <th>Tên tòa nhà</th>
        <th>Địa điểm</th>
        <th>Trạng thái</th>
        <th class="text-center">Lượt xem</th>
        <th class="text-center">Đánh giá</th>
        <th class="text-end">Doanh thu</th>
        <th>Hành động</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="p,iter : ${posts}" th:id="'row-' + ${p.id}">
        <td th:text="${iter.index + 1}">1</td>
        <td>
          <img th:if="${p.imageUrl != null}" th:src="${p.imageUrl}" alt="thumb" class="thumb">
          <div th:if="${p.imageUrl == null}" class="text-muted small">Không ảnh</div>
        </td>
        <td>
          <a th:href="@{'/chi-tiet-toa-nha/' + ${p.id}}" class="fw-semibold text-decoration-none"
             th:text="${p.name}">Tên tòa nhà</a>
          <div class="text-muted small" th:text="${#dates.format(p.createdDate,'dd/MM/yyyy')}">--/--/----</div>
        </td>
        <td>
          <div th:text="${p.district}">Quận</div>
          <div class="text-muted small" th:text="${p.ward}">Phường</div>
        </td>
        <td>
          <span class="status-badge"
                th:classappend="${p.status=='PENDING' ? ' status-pending' :
                                 (p.status=='APPROVED' ? ' status-approved' :
                                  (p.status=='REJECTED' ? ' status-rejected' : ''))}"
                th:text="${p.status}">PENDING</span>
        </td>
        <td class="text-center" th:text="${p.views}">0</td>
        <td class="text-center">
          <span class="rating">
            <span th:text="${#numbers.formatDecimal(p.avgRating,1,1)}">0.0</span>
            <i class="fa-solid fa-star star"></i>
          </span>
          <div class="text-muted small">( <span th:text="${p.reviewCount}">0</span> lượt )</div>
        </td>
        <td class="text-end" th:text="${#numbers.formatInteger(p.revenue,3,'POINT')}">0</td>
        <td>
          <a th:href="@{/web/building-edit/{id}(id=${p.id})}" class="btn btn-sm btn-primary me-1">
            <i class="fa-solid fa-pen-to-square me-1"></i>Sửa
          </a>
          <button type="button" class="btn btn-sm btn-outline-danger btn-delete" th:data-id="${p.id}">
            <i class="fa-solid fa-trash-can me-1"></i>Xoá
          </button>
        </td>
      </tr>

      <tr th:if="${posts == null or #lists.isEmpty(posts)}">
        <td colspan="9" class="text-center text-muted py-4">
          <i class="fa-regular fa-circle-question me-1"></i>Chưa có bài đăng nào.
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- ALERT -->
  <div id="customAlertBackdrop"
       style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.4); z-index: 999;"></div>
  <div id="customAlert"
       style="display:none; position: fixed; top:40%; left:50%; transform:translate(-50%,-50%);
              background:white; padding:25px 35px; border-radius:8px; text-align:center;
              box-shadow:0 3px 10px rgba(0,0,0,0.2); z-index: 1000;">
    <span id="customAlertMessage"></span>
    <button id="customAlertButton" class="btn btn-primary mt-3">OK</button>
  </div>

</main>

<th:block layout:fragment="scripts">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script th:inline="javascript">
    $(function () {
      function customAlert(message, callback) {
        $('#customAlertMessage').text(message);
        $('#customAlertBackdrop, #customAlert').show();
        $('#customAlertButton').off('click').on('click', function () {
          $('#customAlertBackdrop, #customAlert').hide();
          if (callback) callback();
        });
      }

      // Xoá bài đăng (Controller đang là GET)
      $('.btn-delete').click(function () {
        const id = $(this).data('id');
        if (confirm('Bạn có chắc muốn xoá bài đăng này?')) {
          $.ajax({
            type: 'GET',
            url: '/web/building-delete/' + id,
            success: function () {
              customAlert('✅ Xoá bài đăng thành công!', function () {
                $('#row-' + id).remove();
              });
            },
            error: function (xhr) {
              customAlert('❌ Lỗi khi xoá (' + xhr.status + ')');
            }
          });
        }
      });
    });
  </script>
</th:block>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:fragment="pageTitle"
          th:text="'Chi ti·∫øt ' + ${building.name} + ' | SkyLand'">Chi ti·∫øt t√≤a nh√†</title>
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
<main layout:fragment="content" class="page-wrapper">

    <!-- üè¢ HEADER -->
    <section class="intro text-center text-white"
             style="background-image: url('https://bizweb.dktcdn.net/100/328/362/themes/894751/assets/bg_breadcrumb.png?1664350964800');
                    background-size: cover; background-position: center; padding: 60px 0;">
        <h1 class="fw-bold display-5" th:text="${building.name}">T√™n t√≤a nh√†</h1>
        <ul class="list-inline mt-3 mb-0">
            <li class="list-inline-item">
                <a th:href="@{/trang-chu}" class="text-white text-decoration-none">Trang ch·ªß</a>
                <span class="mx-1">/</span>
            </li>
            <li class="list-inline-item">
                <a th:href="@{/san-pham}" class="text-white text-decoration-none">Danh s√°ch t√≤a nh√†</a>
                <span class="mx-1">/</span>
            </li>
            <li class="list-inline-item"><span class="text-light" th:text="${building.name}"></span></li>
        </ul>
    </section>

    <!-- üèôÔ∏è N·ªòI DUNG CH√çNH -->
    <section class="py-5">
        <div class="container">
            <!-- ·∫¢NH -->
            <div class="text-center mb-4">
                <img th:src="@{${building.avatar}}" class="img-fluid rounded shadow" alt="·∫¢nh t√≤a nh√†"
                     style="max-height: 450px; object-fit: cover;">
            </div>

            <!-- Th√¥ng tin chi ti·∫øt -->
            <div class="row">
                <div class="col-md-8">
                    <h4 class="fw-bold text-success mb-3">Th√¥ng tin chi ti·∫øt</h4>
                    <ul class="list-unstyled fs-6">
                        <li><strong>üìç ƒê·ªãa ch·ªâ:</strong> <span th:text="${building.street} + ', ' + ${building.ward} + ', ' + ${building.district}"></span></li>
                        <li><strong>üìê Di·ªán t√≠ch s√†n:</strong> <span th:text="${building.floorArea}"></span> m¬≤</li>
                        <li><strong>üí∞ Gi√° thu√™:</strong> <span th:text="${building.rentPrice}"></span> tri·ªáu/th√°ng</li>
                        <li><strong>üßæ Ph√≠ d·ªãch v·ª•:</strong> <span th:text="${building.serviceFee}"></span></li>
                        <li><strong>üöó Ph√≠ g·ª≠i xe:</strong> <span th:text="${building.carFee}"></span></li>
                        <li><strong>üè¢ S·ªë t·∫ßng h·∫ßm:</strong> <span th:text="${building.numberOfBasement}"></span></li>
                        <li><strong>üß≠ H∆∞·ªõng:</strong> <span th:text="${building.direction}"></span></li>
                        <li><strong>üë§ Qu·∫£n l√Ω:</strong> <span th:text="${building.managerName}"></span> (<span th:text="${building.managerPhone}"></span>)</li>
                        <li><strong>üëÅÔ∏è L∆∞·ª£t xem:</strong> <span th:text="${building.viewCount}"></span></li>
                    </ul>

                    <div class="mt-4">
                        <h5 class="fw-bold text-success">M√¥ t·∫£</h5>
                        <p th:text="${building.description != null ? building.description : 'Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt.'}"></p>
                    </div>
                    <!-- üìà L·ªäCH S·ª¨ GI√Å (Pro UI) -->
					<section class="mt-5" id="price-history">
					  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-3">
					    <div class="kpi-pill">
					      <div class="kpi-value" id="kpiPopular">--</div>
					      <div class="kpi-sub">Gi√° b√°n ph·ªï bi·∫øn nh·∫•t <span id="kpiPopularPeriod"></span></div>
					    </div>
					    <div class="kpi-pill">
					      <div class="kpi-value text-danger" id="kpiYoY">--</div>
					      <div class="kpi-sub">Gi√° b√°n ƒë√£ thay ƒë·ªïi trong 1 nƒÉm</div>
					    </div>
					    <div class="kpi-pill">
					      <div class="kpi-value text-danger" id="kpiBelowPeak">--</div>
					      <div class="kpi-sub">Gi√° hi·ªán t·∫°i th·∫•p h∆°n ƒë·ªânh <span id="kpiPeakPeriod"></span></div>
					    </div>
					
					    <div class="btn-group ms-auto kpi-range">
					      <button class="btn btn-outline-secondary" data-range="1y">1 nƒÉm</button>
					      <button class="btn btn-outline-secondary" data-range="2y">2 nƒÉm</button>
					      <button class="btn btn-outline-secondary" data-range="5y">5 nƒÉm</button>
					    </div>
					  </div>
					
					  <div class="card shadow-sm border-0">
					    <div class="card-body p-3 p-md-4">
					      <div class="chart-wrap">
					        <canvas id="priceChart" height="120"></canvas>
					        <div class="empty-state d-none" id="priceEmpty">
					          Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.
					        </div>
					      </div>
					    </div>
					  </div>
					</section>
                    
                    
                    <!-- üí¨ B√åNH LU·∫¨N & ƒê√ÅNH GI√Å -->
                    <div class="mt-5">
                        <h4 class="fw-bold text-success mb-3">üí¨ ƒê√°nh gi√° & B√¨nh lu·∫≠n</h4>

                        <!-- Form b√¨nh lu·∫≠n (ch·ªâ kh√°ch h√†ng ƒë√£ ƒëƒÉng nh·∫≠p) -->
                        <div th:if="${#authorization.expression('isAuthenticated()')}">
				              <form id="reviewForm" class="mb-4">
				                <input type="hidden" id="buildingId" th:value="${building.id}" />

                                <div class="mb-3">
                                    <label for="rating" class="form-label">Ch·ªçn s·ªë sao:</label>
                                    <div id="ratingStars" class="rating-stars mb-2">
									  <i class="fa-solid fa-star fs-4 text-secondary" data-value="1"></i>
									  <i class="fa-solid fa-star fs-4 text-secondary" data-value="2"></i>
									  <i class="fa-solid fa-star fs-4 text-secondary" data-value="3"></i>
									  <i class="fa-solid fa-star fs-4 text-secondary" data-value="4"></i>
									  <i class="fa-solid fa-star fs-4 text-secondary" data-value="5"></i>
									</div>

                                    <input type="hidden" id="ratingValue" value="0" />
                                </div>

                                <div class="mb-3">
                                    <textarea id="reviewContent" class="form-control" rows="3"
                                              placeholder="Nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n..."></textarea>
                                </div>

                                <button type="button" id="submitReview" class="btn btn-success">
                                    G·ª≠i b√¨nh lu·∫≠n
                                </button>
                            </form>
                        </div>

                        <!-- N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -->
			            <div th:if="${!#authorization.expression('isAuthenticated()')}" class="text-muted fst-italic">
			              Vui l√≤ng <a th:href="@{/login}" class="text-success fw-bold">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.
			            </div>

                        <!-- Danh s√°ch b√¨nh lu·∫≠n -->
                        <div id="reviewList" class="mt-4 border-top pt-3">
                            <div id="reviewsContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- GOOGLE MAP -->
                <div class="col-md-4">
                    <h4 class="fw-bold text-success mb-3">üìç V·ªã tr√≠ tr√™n b·∫£n ƒë·ªì</h4>
                    <iframe th:src="'https://www.google.com/maps?q=' + ${building.street} + ',' + ${building.district} + '&output=embed'"
                            width="100%" height="350" style="border:0;" loading="lazy"></iframe>
                </div>
            </div>

            <!-- T√íA NH√Ä T∆Ø∆†NG T·ª∞ -->
            <div class="mt-5">
                <h4 class="fw-bold text-success mb-4">üèóÔ∏è T√≤a nh√† t∆∞∆°ng t·ª±</h4>
                <div class="row g-4" th:if="${!#lists.isEmpty(related)}">
                    <div class="col-md-3" th:each="r : ${related}">
                        <div class="card h-100 shadow-sm border-0">
                            <img th:src="@{${r.avatar}}" class="card-img-top" alt="·∫¢nh t√≤a nh√†"
                                 style="height: 180px; object-fit: cover;">
                            <div class="card-body">
                                <h6 class="fw-bold" th:text="${r.name}"></h6>
                                <p class="small text-muted">
                                    <i class="fa-solid fa-location-dot text-danger"></i>
                                    <span th:text="${r.district}"></span>
                                </p>
                                <p class="small mb-2">
                                    üí∞ <span th:text="${r.rentPrice}"></span> tri·ªáu/th√°ng
                                </p>
                                <a th:href="@{'/chi-tiet-toa-nha/' + ${r.id}}" class="btn btn-outline-success btn-sm w-100">
                                    Xem chi ti·∫øt
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(related)}" class="text-muted fst-italic">Kh√¥ng c√≥ t√≤a nh√† t∆∞∆°ng t·ª±.</div>
            </div>
        </div>
    </section>
</main>


<th:block layout:fragment="scripts">

<!-- üí¨ JS X·ª≠ l√Ω b√¨nh lu·∫≠n -->
<script th:inline="javascript">
document.addEventListener("DOMContentLoaded", function () {
  const stars = document.querySelectorAll("#ratingStars i");
  const ratingInput = document.getElementById("ratingValue");
  const buildingId = document.getElementById("buildingId") ? document.getElementById("buildingId").value : null;
  
//‚úÖ L·∫•y username hi·ªán t·∫°i (n·∫øu c√≥)
  const currentUser = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false 
    ? /*[[${#authentication.principal?.username}]]*/ "" 
    : null;

  if (!buildingId) return;

  // ‚≠ê Ch·ªçn sao
  stars.forEach(star => {
    star.addEventListener("click", function () {
      const rating = this.getAttribute("data-value");
      ratingInput.value = rating;
      stars.forEach(s => s.classList.remove("active", "text-warning"));
      for (let i = 0; i < rating; i++) stars[i].classList.add("active", "text-warning");
    });
  });


//üì¶ Load danh s√°ch b√¨nh lu·∫≠n
  loadReviews();
  function loadReviews() {
    fetch(`/api/review/${buildingId}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("reviewsContainer");
        container.innerHTML = "";
        if (data.length === 0) {
          container.innerHTML = "<p class='text-muted fst-italic'>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>";
        } else {
        	data.forEach(r => {
        		  const name = r.username || "·∫®n danh";
        		  const canDelete = (r.username === currentUser); // ‚úÖ ch·ªâ ng∆∞·ªùi ƒëƒÉng nh·∫≠p m·ªõi th·∫•y n√∫t xo√°
        		  const deleteBtn = canDelete
        		    ? `<button class="btn btn-sm btn-outline-danger float-end" onclick="deleteReview(${r.id})">
        		         <i class="fa-solid fa-trash"></i>
        		       </button>`
        		    : "";
        		  container.innerHTML += `
        		    <div class="mb-3 border-bottom pb-2">
        		      <strong class="text-success">${name}</strong>
        		      <span class="text-warning ms-2">${"‚≠ê".repeat(r.rating)}</span>
        		      ${deleteBtn}
        		      <br>
        		      <small class="text-muted">${new Date(r.createdDate).toLocaleString()}</small>
        		      <p class="mt-1">${r.content}</p>
        		    </div>`;
        		});

        }
      });
	}

//üöÄ G·ª≠i b√¨nh lu·∫≠n
  const submitBtn = document.getElementById("submitReview");
  if (submitBtn) {
    submitBtn.addEventListener("click", function () {
      const rating = parseInt(ratingInput.value);
      const content = document.getElementById("reviewContent").value.trim();
      if (!content || rating === 0) {
        alert("Vui l√≤ng nh·∫≠p n·ªôi dung v√† ch·ªçn s·ªë sao!");
        return;
      }

      fetch("/api/review", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include", // ‚úÖ g·ª≠i cookie ƒëƒÉng nh·∫≠p
        body: JSON.stringify({ buildingId, content, rating })
      })
        .then(res => {
          if (res.status === 401) {
            alert("‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n!");
            return null;
          }
          return res.json();
        })
        .then(res => {
          if (res?.message === "success") {
            alert("‚úÖ ƒê√£ g·ª≠i b√¨nh lu·∫≠n!");
            document.getElementById("reviewContent").value = "";
            ratingInput.value = 0;
            stars.forEach(s => s.classList.remove("active", "text-warning"));
            loadReviews();
          } else if (res) {
            alert(res.message || "‚ùå L·ªói khi g·ª≠i b√¨nh lu·∫≠n!");
          }
        });
    });
  }
//üóë H√†m xo√° b√¨nh lu·∫≠n
  function deleteReview(id) {
    if (confirm("üóë B·∫°n c√≥ ch·∫Øc mu·ªën xo√° b√¨nh lu·∫≠n n√†y kh√¥ng?")) {
      fetch(`/api/review/${id}`, {
        method: "DELETE",
        credentials: "include"
      })
        .then(res => res.json())
        .then(res => {
          if (res.message === "success") {
            alert("‚úÖ ƒê√£ xo√° b√¨nh lu·∫≠n!");
            loadReviews();
          } else {
            alert(res.message || "‚ùå L·ªói khi xo√° b√¨nh lu·∫≠n!");
          }
        });
    }
  }

});
//üóë H√†m xo√° b√¨nh lu·∫≠n ‚Äî ƒë·∫∑t NGO√ÄI document.addEventListener
window.deleteReview = function (id) {
  if (confirm("üóë B·∫°n c√≥ ch·∫Øc mu·ªën xo√° b√¨nh lu·∫≠n n√†y kh√¥ng?")) {
    fetch(`/api/review/${id}`, {
      method: "DELETE",
      credentials: "include" // ‚úÖ g·ª≠i cookie ƒëƒÉng nh·∫≠p
    })
      .then(res => res.json())
      .then(res => {
        if (res.message === "success") {
          alert("‚úÖ ƒê√£ xo√° b√¨nh lu·∫≠n!");
          // ‚úÖ Sau khi xo√° th√†nh c√¥ng, reload l·∫°i danh s√°ch b√¨nh lu·∫≠n
          if (typeof loadReviews === "function") loadReviews();
        } else {
          alert(res.message || "‚ùå L·ªói khi xo√° b√¨nh lu·∫≠n!");
        }
      })
      .catch(err => console.error("‚ùå L·ªói khi xo√° b√¨nh lu·∫≠n:", err));
  }
};


</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<style>
  /* KPI cards gi·ªëng style ·∫£nh b·∫°n g·ª≠i */
  #price-history .kpi-pill{
    background:#fff;border:1px solid #eef0f3;border-radius:14px;padding:16px 20px;
    min-width:280px;box-shadow:0 2px 10px rgba(0,0,0,.04)
  }
  #price-history .kpi-value{font-size:32px;font-weight:800;line-height:1}
  #price-history .kpi-sub{color:#6b7280;font-size:14px;margin-top:6px}
  #price-history .kpi-range .btn{min-width:82px}
  #price-history .kpi-range .btn.active{background:#1f2937;color:#fff;border-color:#1f2937}

  .chart-wrap{position:relative;min-height:280px}
  .empty-state{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    color:#9aa0a6;font-weight:600;background:
    repeating-linear-gradient(-45deg,#fafafa,#fafafa 10px,#f6f7f8 10px,#f6f7f8 20px);
    border-radius:10px
  }
</style>

<script th:inline="javascript">
  let priceChart;
  const buildingId = /*[[${building.id}]]*/ 0;

  const fmt = n => n==null ? '--' : `${n.toLocaleString('vi-VN')} tr/m¬≤`;
  const pct = n => n==null ? '--' : `${n.toFixed(1)}%`;

  async function loadPrice(range='1y'){
    // set button active state
    document.querySelectorAll('.kpi-range .btn').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.range===range);
    });

    const res = await fetch(`/api/market/price-history?buildingId=${buildingId}&range=${range}`);
    const data = await res.json();

    // empty state
    const empty = document.getElementById('priceEmpty');
    if(!data || !Array.isArray(data.series) || data.series.length===0){
      empty.classList.remove('d-none');
      if (priceChart) priceChart.destroy();
      return;
    } else {
      empty.classList.add('d-none');
    }

    // KPIs
    document.getElementById('kpiPopular').innerText = fmt(data.latestPopular);
    document.getElementById('kpiPopularPeriod').innerText = data.latestPeriod ? `(${data.latestPeriod})` : '';
    document.getElementById('kpiYoY').innerText = (data.yoyChangePct>=0?'+':'') + pct(data.yoyChangePct);
    document.getElementById('kpiBelowPeak').innerText = pct(data.belowPeakPct);
    document.getElementById('kpiPeakPeriod').innerText = data.peakPeriod ? `(${data.peakPeriod})` : '';

    // Chart data
    const labels = data.series.map(p => p.period);
    const min = data.series.map(p => p.min);
    const med = data.series.map(p => p.med);
    const max = data.series.map(p => p.max);

    // optional gradient strokes (ƒë·∫πp m·∫Øt, kh√¥ng set m√†u c·ª©ng)
    const ctx = document.getElementById('priceChart').getContext('2d');

    if (priceChart) priceChart.destroy();
    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Gi√° cao nh·∫•t',
            data: max,
            fill: false,
            tension: .3,
            pointRadius: 3
          },
          {
            label: 'Gi√° ph·ªï bi·∫øn nh·∫•t',
            data: med,
            fill: false,
            tension: .3,
            pointRadius: 3
          },
          {
            label: 'Gi√° th·∫•p nh·∫•t',
            data: min,
            fill: false,
            tension: .3,
            pointRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${fmt(ctx.raw)}` } }
        },
        scales: {
          y: {
            grid: { color: 'rgba(0,0,0,.06)' },
            title: { display: true, text: 'tr/m¬≤' },
            ticks: { callback: v => v.toLocaleString('vi-VN') }
          },
          x: {
            grid: { display: false },
            title: { display: true, text: 'K·ª≥ (Qu√Ω)' }
          }
        }
      }
    });
  }

  // range switchers
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.kpi-range .btn');
    if(!btn) return;
    loadPrice(btn.dataset.range);
  });

  document.addEventListener('DOMContentLoaded', ()=> loadPrice('1y'));
</script>

<!-- N√∫t Zalo n·ªïi -->
<a href="https://zalo.me/0896980501" target="_blank" id="zaloButton" title="Li√™n h·ªá qua Zalo">
    <img th:src="@{/images/zalo-icon.png}" alt="Zalo">
</a>

<style>
.rating-stars { display: flex; gap: 6px; font-size: 26px; cursor: pointer; }
.rating-stars i { color: #ccc; transition: color 0.2s, transform 0.2s; }
.rating-stars i:hover { transform: scale(1.2); }
.rating-stars i.active { color: gold; }
#zaloButton {
  position: fixed;
  bottom: 80px;
  right: 25px;
  z-index: 1000;
  background: white;
  border: 2px solid #198754;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
  transition: transform 0.2s;
}
#zaloButton:hover { transform: scale(1.1); }
#zaloButton img { width: 38px; height: 38px; }
</style>
</th:block>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title layout:fragment="pageTitle">Lịch sử giá | SkyLand</title>
</head>
<body>
<main layout:fragment="content" class="container py-4">

    <div class="card p-3 mb-3 shadow-sm">
        <div class="d-flex gap-4 align-items-end">
            <div>
                <div class="h2" id="popular">--</div>
                <div>Giá phổ biến nhất</div>
            </div>
            <div>
                <div class="h2 text-danger" id="yoy">--</div>
                <div>1 năm</div>
            </div>
            <div>
                <div class="h2 text-danger" id="belowPeak">--</div>
                <div>Thấp hơn đỉnh</div>
            </div>
            <div class="ms-auto btn-group">
                <button class="btn btn-outline-secondary" onclick="loadRange('1y')">1 năm</button>
                <button class="btn btn-outline-secondary" onclick="loadRange('2y')">2 năm</button>
                <button class="btn btn-outline-secondary" onclick="loadRange('5y')">5 năm</button>
            </div>
        </div>
    </div>

    <div class="card p-3 shadow-sm">
        <canvas id="priceChart" height="120" aria-label="Biểu đồ lịch sử giá" role="img"></canvas>
        <div id="noData" class="text-center text-muted py-4 d-none">
            Không có dữ liệu lịch sử giá cho khoảng thời gian này.
        </div>
    </div>

</main>

<th:block layout:fragment="scripts">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script th:inline="javascript">
    let chart;

    // ✅ Id tòa nhà từ Controller
    const buildingId = /*[[${buildingId}]]*/ 0;

    // ✅ Luôn đúng context-path (Thymeleaf sẽ thay đúng URL)
    const apiUrl = /*[[@{/api/market/price-history}]]*/ '/api/market/price-history';

    function fmt(n){ return n==null ? '--' : (n.toLocaleString('vi-VN') + ' tr/m²'); }
    function pct(n){ return n==null ? '--' : (n.toFixed(1) + '%'); }

    function setHeadline(data){
        document.getElementById('popular').innerText   = fmt(data.latestPopular);
        document.getElementById('yoy').innerText       = (data.yoyChangePct>=0?'+':'') + pct(data.yoyChangePct);
        document.getElementById('belowPeak').innerText = pct(data.belowPeakPct);
    }

    function renderChart(series){
        const labels = series.map(p => p.period);
        const min    = series.map(p => p.min);
        const med    = series.map(p => p.med);
        const max    = series.map(p => p.max);

        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('priceChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Giá thấp nhất', data: min, tension: .3 },
                    { label: 'Giá phổ biến',  data: med, tension: .3 },
                    { label: 'Giá cao nhất',  data: max, tension: .3 }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: true } },
                scales: { x: { title: { display: true, text: 'Kỳ (Quý)' } },
                          y: { title: { display: true, text: 'triệu/m²' } } }
            }
        });
    }

    async function loadRange(range){
        try {
            const res = await fetch(`${apiUrl}?buildingId=${buildingId}&range=${range}`);
            if (!res.ok) {
                console.error('API error:', res.status);
                alert('Không tải được dữ liệu lịch sử giá (' + res.status + ')');
                return;
            }
            const data = await res.json();
            console.log('price-history:', data);

            setHeadline(data);

            const series = (data.series ?? []);
            const noDataEl = document.getElementById('noData');
            const canvasEl = document.getElementById('priceChart');

            if (series.length === 0) {
                // Ẩn chart, hiện thông báo
                if (chart) chart.destroy();
                canvasEl.classList.add('d-none');
                noDataEl.classList.remove('d-none');
                return;
            } else {
                noDataEl.classList.add('d-none');
                canvasEl.classList.remove('d-none');
            }

            renderChart(series);
        } catch (e) {
            console.error(e);
            alert('Lỗi khi tải dữ liệu lịch sử giá');
        }
    }

    // Mặc định hiển thị 1 năm
    loadRange('1y');
</script>
</th:block>
</body>
</html>

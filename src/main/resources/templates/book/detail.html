<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title>Chi ti·∫øt s√°ch</title>
</head>
<body>
<main layout:fragment="content" class="container mt-4">

    <!-- Hi·ªÉn th·ªã l·ªói n·∫øu c√≥ -->
    <div th:if="${param.error != null}" class="alert alert-danger">
        <span th:text="${param.error}">L·ªói</span>
    </div>

    <h2 class="mb-4">üìñ Chi ti·∫øt s√°ch</h2>

    <!-- Ki·ªÉm tra book c√≥ t·ªìn t·∫°i kh√¥ng -->
    <div th:if="${book != null}">
        <div class="card mb-4 shadow-sm">
            <div class="row g-0">
                <div class="col-md-4">
                    <!-- Ki·ªÉm tra coverImage c√≥ t·ªìn t·∫°i kh√¥ng -->
                    <img th:if="${book.coverImage != null and book.coverImage != ''}" 
                         th:src="@{'/images/' + ${book.coverImage}}" 
                         class="img-fluid rounded-start" 
                         alt="Cover"/>
                    <img th:unless="${book.coverImage != null and book.coverImage != ''}" 
                         src="/images/default-book.jpg" 
                         class="img-fluid rounded-start" 
                         alt="Default Cover"/>
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h4 class="card-title" th:text="${book.title} ?: 'Ch∆∞a c√≥ ti√™u ƒë·ªÅ'"></h4>
                        <p><strong>M√£ ISBN:</strong> <span th:text="${book.isbn} ?: 'N/A'"></span></p>
                        <p><strong>T√°c gi·∫£:</strong> 
                            <span th:if="${book.authorNames != null and !book.authorNames.isEmpty()}" 
                                  th:text="${#strings.join(book.authorNames, ', ')}"></span>
                            <span th:unless="${book.authorNames != null and !book.authorNames.isEmpty()}">Ch∆∞a c√≥</span>
                        </p>
                        <p><strong>Publisher:</strong> <span th:text="${book.publisher} ?: 'N/A'"></span></p>
                        <p><strong>Ng√†y xu·∫•t b·∫£n:</strong> 
                            <span th:if="${book.publishDate != null}" 
                                  th:text="${#temporals.format(book.publishDate, 'dd/MM/yyyy')}"></span>
                            <span th:unless="${book.publishDate != null}">N/A</span>
                        </p>
                        <p><strong>S·ªë l∆∞·ª£ng:</strong> <span th:text="${book.quantity} ?: '0'"></span></p>
                        <p><strong>Gi√°:</strong> <span th:text="${book.price} ?: '0'"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review list -->
        <h4>ƒê√°nh gi√° (Review)</h4>
        <div th:if="${ratings == null or #lists.isEmpty(ratings)}">
            <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho s√°ch n√†y.</p>
        </div>
        <ul class="list-group mb-4" th:if="${ratings != null and !#lists.isEmpty(ratings)}">
            <li class="list-group-item" th:each="rating : ${ratings}">
                <strong>Ng∆∞·ªùi d√πng ID:</strong> <span th:text="${rating.user != null ? rating.user.id : 'N/A'}"></span> |
                <strong>ƒêi·ªÉm:</strong> <span th:text="${rating.rating} ?: '0'"></span><br/>
                <strong>Review:</strong> <span th:text="${rating.reviewText} ?: 'Kh√¥ng c√≥ n·ªôi dung'"></span>
            </li>
        </ul>

        <!-- Add review -->
        <h4>Th√™m ƒë√°nh gi√° m·ªõi</h4>
        <form th:action="@{'/books/' + ${book.bookId} + '/reviews'}" 
              method="post" class="mb-3">
            <input type="hidden" name="userId" value="1"/> <!-- demo user -->
            
            <div class="mb-2">
                <label>ƒêi·ªÉm (1-5):</label>
                <input type="number" name="rating" class="form-control" min="1" max="5" required/>
            </div>
            
            <div class="mb-2">
                <label>B√¨nh lu·∫≠n:</label>
                <textarea name="reviewText" class="form-control" required></textarea>
            </div>
            
            <button type="submit" class="btn btn-success">G·ª≠i ƒë√°nh gi√°</button>
        </form>
    </div>

    <!-- Hi·ªÉn th·ªã n·∫øu book kh√¥ng t·ªìn t·∫°i -->
    <div th:unless="${book != null}">
        <div class="alert alert-warning">
            <p>S√°ch kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</p>
        </div>
    </div>

    <a th:href="@{/books}" class="btn btn-secondary">‚Üê Quay l·∫°i danh s√°ch</a>

</main>
</body>
</html>